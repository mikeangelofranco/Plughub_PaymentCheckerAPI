<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Subscriber Directory â€“ Ubuntu Deployment Guide</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 24px; line-height: 1.5; }
    h1, h2 { color: #38bdf8; }
    code { background: rgba(15,23,42,0.8); padding: 2px 6px; border-radius: 4px; }
    pre { background: rgba(15,23,42,0.8); padding: 12px; border-radius: 8px; overflow: auto; }
    ol { padding-left: 20px; }
    li { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Subscriber Directory Deployment (Ubuntu 22.04+)</h1>
  <p>Domain: <code>https://subs.plughub-ims.com/</code>. App root: <code>/srv/subscriber_directory</code>. Database: Postgres (<code>plughub</code>/<code>Cablet0w</code> user) with a dedicated DB.</p>

  <h2>1) System prep</h2>
  <pre>sudo apt update && sudo apt upgrade -y
sudo apt install -y python3-venv python3-pip python3-dev libpq-dev postgresql postgresql-contrib nginx certbot python3-certbot-nginx</pre>

  <h2>2) Database (separate DB for this app)</h2>
  <pre>sudo -iu postgres psql -c "CREATE USER plughub WITH PASSWORD 'Cablet0w';"
sudo -iu postgres psql -c "CREATE DATABASE plughub_paymentchecker OWNER plughub;"
sudo -iu postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE plughub_paymentchecker TO plughub;"</pre>

  <h2>3) Deploy code to /srv</h2>
  <pre># copy from Windows to Ubuntu tmp (on Windows Powershell or CMD):
# scp subscriber_directory_release.zip user@your-server:/tmp/

# on Ubuntu
cd /tmp
unzip -o subscriber_directory_release.zip
sudo mkdir -p /srv/subscriber_directory
sudo rsync -a /tmp/portal /tmp/plughub_paymentchecker /tmp/templates /tmp/static /tmp/manage.py /tmp/requirements.txt /tmp/README.md /tmp/RELEASE_NOTES.md /tmp/DEPLOYMENT.html /tmp/.env.example /srv/subscriber_directory/
cd /srv/subscriber_directory
python3 -m venv .venv
. .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt</pre>

  <h2>4) Environment config</h2>
<pre>cp .env.example .env
nano .env  # set ALLOWED_HOSTS=subs.plughub-ims.com, actual DB password, API keys, PAYMONGO_WEBHOOK_SECRET</pre>

  <h2>5) Django setup</h2>
  <pre>. .venv/bin/activate
python manage.py migrate
python manage.py collectstatic --noinput
python manage.py createsuperuser  # optional admin login</pre>

  <h2>6) Gunicorn systemd service</h2>
  <pre>sudo tee /etc/systemd/system/subscriber-directory.service &lt;&lt;'EOF'
[Unit]
Description=Subscriber Directory Gunicorn
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/srv/subscriber_directory
EnvironmentFile=/srv/subscriber_directory/.env
ExecStart=/srv/subscriber_directory/.venv/bin/gunicorn plughub_paymentchecker.wsgi:application \
  --bind unix:/srv/subscriber_directory/run/gunicorn.sock --workers 3
Restart=always

[Install]
WantedBy=multi-user.target
EOF
sudo mkdir -p /srv/subscriber_directory/run
sudo chown www-data:www-data /srv/subscriber_directory/run
sudo systemctl daemon-reload
sudo systemctl enable subscriber-directory
sudo systemctl start subscriber-directory
sudo systemctl status subscriber-directory --no-pager</pre>

  <h2>7) Nginx reverse proxy</h2>
  <pre>sudo tee /etc/nginx/sites-available/subscriber-directory &lt;&lt;'EOF'
server {
    listen 80;
    server_name subs.plughub-ims.com;

    location /static/ {
        alias /srv/subscriber_directory/static/;
    }

    location / {
        include proxy_params;
        proxy_pass http://unix:/srv/subscriber_directory/run/gunicorn.sock;
    }
}
EOF
sudo ln -sf /etc/nginx/sites-available/subscriber-directory /etc/nginx/sites-enabled/subscriber-directory
sudo nginx -t
sudo systemctl restart nginx</pre>

  <h2>8) TLS (Let's Encrypt)</h2>
  <pre>sudo certbot --nginx -d subs.plughub-ims.com --non-interactive --agree-tos -m admin@subs.plughub-ims.com
sudo systemctl reload nginx</pre>

  <h2>9) Smoke test</h2>
  <pre>curl -I https://www.subs.plughub-ims.com/
curl -X POST https://www.subs.plughub-ims.com/api/logpayments/ \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: &lt;your-dev-key&gt;" \
  -d '{"data":{"name":"Smoke","email":"smoke@example.com","amount":"1.00","reference":"SMOKE-REF","paymentid":"SMOKE-PAY","status":"Paid"}}'</pre>

  <h2>Notes</h2>
  <ul>
    <li>Keep <code>DEBUG=False</code> and set <code>ALLOWED_HOSTS</code> in <code>.env</code>.</li>
    <li>PayMongo webhooks: point to <code>/api/logpayments/</code>, use the Paymongo signature secret in the env.</li>
    <li>Use the dedicated DB <code>plughub_paymentchecker</code> to keep IMS/Queueing isolated.</li>
  </ul>
</body>
</html>
